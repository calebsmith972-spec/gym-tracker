<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPLA System Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-purple: #bd00ff;
            --bg-dark: #050510;
            --panel-bg: #0a0a14;
        }

        body {
            background-color: var(--bg-dark);
            color: #e0e7ff;
            font-family: 'Rajdhani', sans-serif;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        h1, h2, h3, .tech-font {
            font-family: 'Orbitron', sans-serif;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a14; }
        ::-webkit-scrollbar-thumb { background: #1e1e2e; border-radius: 3px; border: 1px solid var(--neon-cyan); }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-cyan); }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Neon Effects */
        .neon-border-cyan {
            border: 1px solid var(--neon-cyan);
            box-shadow: 0 0 5px rgba(0, 243, 255, 0.2), inset 0 0 10px rgba(0, 243, 255, 0.1);
        }
        
        .neon-border-pink {
            border: 1px solid var(--neon-pink);
            box-shadow: 0 0 5px rgba(255, 0, 255, 0.2), inset 0 0 10px rgba(255, 0, 255, 0.1);
        }

        .neon-text-cyan {
            color: var(--neon-cyan);
            text-shadow: 0 0 8px rgba(0, 243, 255, 0.6);
        }

        .neon-text-pink {
            color: var(--neon-pink);
            text-shadow: 0 0 8px rgba(255, 0, 255, 0.6);
        }

        .glass-panel {
            background: rgba(10, 10, 20, 0.85);
            backdrop-filter: blur(8px);
        }

        .modal-overlay { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
        
        /* Intensity Set Gradient */
        .intensity-border {
            position: relative;
            background: #0a0a14;
            border: 1px solid transparent;
        }
        .intensity-border::before {
            content: "";
            position: absolute;
            inset: -1px;
            z-index: -1;
            border-radius: inherit;
            background: linear-gradient(45deg, var(--neon-purple), var(--neon-pink));
        }

        /* Inputs */
        input[type="number"] {
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 1px solid #333;
            transition: all 0.2s;
        }
        input[type="number"]:focus {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 8px rgba(0, 243, 255, 0.3);
            outline: none;
        }

        .crt-overlay {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            opacity: 0.15;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="crt-overlay"></div>

    <div id="app" class="max-w-md mx-auto min-h-screen bg-[#050510] border-x border-slate-800 shadow-2xl relative flex flex-col"></div>

    <script>
        // --- 1. ROBUST DATA PARSING ---

        function cleanRepString(val) {
            if (!val) return '';
            const dateMatch = val.match(/^\d{4}-(\d{2})-(\d{2})$/);
            if (dateMatch) {
                return `${parseInt(dateMatch[1])}-${parseInt(dateMatch[2])}`;
            }
            return val;
        }

        const DEFAULT_CSV_CONTENT = `Week 1,Exercise,Last-Set Intensity,Warm Up Sets,Working Sets,Reps,Tracking Load and Reps,,,,Early Set RPE,Last Set RPE,Rest,Substitution Option 1,Substitution Option 2,Notes
Pull #1 (Lat Focus),,,,,,,,,,,,,,
,Cross-Body Lat Pull-Around,"Long-length Partials (on all reps of the last set)",1,3,10-12,,,,,9,10,2-3 min,Half-Kneeling 1- Arm Lat Pulldown,Neutral-Grip Pullup,"Try to keep the cable and your wrist aligned in a straight line throughout the pull. Feel a nice, deep lat stretch at the top."
,Snatch Grip RDL,N/A,3,2,8,,,,,6,6-7,3-4 min,DB RDL,Nordic Ham Curl,"The RPE is intentionally low here because these will cause a lot of muscle damage. Don't be tempted to go too heavy. 1 second pause at the bottom of each rep. To keep tension on the hamstrings, stop about 75% of the way to full lockout on each rep (i.e. stay in the bottom 3/4 of the range of motion)."
,Chest Supported Machine Row,"Long-length Partials (on all reps of the last set)",2,3,8-10,,,,,9,10,2-3 min,Chest Supported T-Bar Row,Helms Row,"Flare elbows out at roughly 45° and squeeze your shoulder blades together hard at the top of each rep."
,Straight Bar Lat Prayer,"Long-length Partials (on all reps of the last set)",1,3,12-15,,,,,9-10,10,1-2 min,Machine Lat Pullover,DB Lat Pullover,"Lean forward to get a big stretch on the lats at the top of the ROM and then stand upright as you squeeze your lats at the bottom."
,Hammer Preacher Curl,N/A,1,3,10-12,,,,,9-10,10,1-2 min,Fat-Grip Preacher Curl,Hammer Curl,"These will target the brachialis and forearms hard. Squeeze the dumbbell hard in the middle of the handle and curl about 3/4 of the way up (i.e. stay in the bottom 3/4 of the curl)."
,Lying Paused Rope Face Pull,N/A,1,3,10-12,,,,,9-10,10,1-2 min,Rope Face Pull,Bent-Over Reverse DB Flye,"Pause for 1-2 seconds in the squeeze of each rep. Contract the rear delts hard!"
,,,,,,,,,,,,,,
Push #1,,,,,,,,,,,,,,
,Cuffed Behind-The-Back Lateral Raise,"Myo-reps",2,3,10-12,,,,,9-10,10,1-2 min,Cross-Body Cable Y-Raise,DB Lateral Raise,"Raise the cables up and out in a ""Y"" motion. Really try to connect with the middle delt fibers as you sweep the weight up and out."
,Low Incline Smith Machine Press,"Pec Static Stretch (30 sec hold)",3,4,8-10,,,,,8-9,9-10,2-3 min,Low Incline Machine Press,Low Incline DB Press,"Set the bench at a ~15° incline. 1 second pause on the chest on each rep while maintaining tension on the pecs."
,Pec Deck (w/ Integrated Partials),"Integrated Partials (on all sets)",1,3,12-15,,,,,8-9,10,1-2 min,Bent-Over Cable Pec Flye (w/ integrated Partials),DB Flye (w/ Integrated Partials),"Set up the pec deck to allow for maximum stretch. On all sets, alternate full-ROM reps and half-ROM reps (i.e. do 1 rep with full-ROM, then 1 rep half-ROM (in the stretched/bottom half), then 1 rep full-ROM, then 1 rep half-ROM). Repeat until you've reached the target reps and an RPE of 9-10."
,Overhead Cable Triceps Extension (Bar),Dropset,1,3,8,,,,,9-10,10,1-2 min,Overhead Cable Triceps Extension (Rope),DB Skrullcrusher,"Feel a nasty stretch on the triceps throughout the entire negative. Pause for 1 second in the stretch part of each rep."
,Triceps Pressdown (Bar),Dropset,1,2,8-10,,,,,9-10,10,1-2 min,Triceps Pressdown (Rope),Close-Grip Assisted Dip,"These are meant to be fairly heavy, which is why we're using a bar instead of a rope. Aim to add some weight week to week at the set rep target. Always keep the form tight as you overload the triceps."
,Cable Crunch,"Myo-reps",1,3,10-12,,,,,9-10,10,1-2 min,Machine Crunch,Plate-Weighted Crunch,"Round your lower back as you crunch. Maintain a mind-muscle connection with your 6-pack."
,,,,,,,,,,,,,,
Legs #1,,,,,,,,,,,,,,
,Seated Leg Curl,N/A,2,3,8-10,,,,,9,10,2-3 min,Lying Leg Curl,Nordic Ham Curl,"Lean forward over the machine to get a maximum stretch in your hamstrings."
,Machine Hip Adduction,N/A,1,3,10-12,,,,,9,10,2-3 min,Cable Hip Adduction,Copenhagen Hip Adduction,"Mind-muscle connection with your inner thighs. These are great for adding thigh mass from the front! Push them hard!"
,Hack Squat,N/A,4,3,4|6|8,,,,,9,9,3-5 min,Machine Squat,Front Squat,"We're using a reverse pyramid on this exercise. Warm-up as usual to your first working set for 4 reps. This first set will be your heaviest set. Then for set 2, drop the weight back ~10-15% and do 6 reps. Then for set 3, drop the weight back another 10-15% and do 8 reps."
,Leg Extension,"Long-length Partials (on all reps of the last set)",2,3,10-12,,,,,9,10,1-2 min,DB Step-Up,Reverse Nordics,"Set the seat back as far as it will go while still feeling comfortable. Grab the handles as hard as you can to pull your butt down into the seat. Use a 2-3 second negative. Feel your quads pulling apart on the negative."
,Leg Press Calf Press,"Calf Static Stretch (30 sec)",1,3,12-15,,,,,9-10,10,1-2 min,Donkey Calf Raise,Seated Calf Raise,"1-2 second pause at the bottom of each rep. Instead of just going up onto your toes, think about rolling your ankle back and forth on the balls of your feet."
,,,,,,,,,,,,,,
Arms and Weak Points #1,,,,,,,,,,,,,,
,Weak Point Exercise 1,N/A,3,3,8-12,,,,,9,9-10,1-3 min,,,
,Weak Point Exercise 2,N/A,3,3,8-12,,,,,9,9-10,1-3 min,,,
,Bayesian Cable Curl,"Long-length Partials (on all reps of the last set)",1,3,10-12,,,,,9-10,10,1-2 min,DB Incline Curl,DB Scott Curl,"If you have a left-right bicep size imbalance, do these 1 arm at a time, starting with the weaker arm. Take the weaker arm to an RPE of 9-10. Then match the reps with the other arm (stop once you've matched the reps, even if the RPE is lower). If you don't have a size imbalance, do these both arms at the same time."
,Seated DB French Press,N/A,1,3,10,,,,,9-10,10,1-2 min,EZ-bar Skull Crusher,DB Skull Crusher,"Place both palms under the head of a dumbbell and perform overhead extensions. Feel a deep stretch on your triceps at the bottom. Avoid pausing at the top of each rep."
,Bottom-2/3 Constant Tension Preacher Curl,N/A,1,2,12-15,,,,,9-10,10,1-2 min,Bottom-2/3 EZ Bar Curl,Spider Curl,"Stay in the bottom 2/3 of the curl. Don't squeeze all the way up to the top. Keep your triceps firmly pinned against the pad as you curl. No pausing at the top or bottom: constant tension on the biceps!"
,Cable Triceps Kickbacks,N/A,0,2,12-15,,,,,9-10,10,1-2 min,Bench Dip,DB Triceps Kickback,"There are two ways you can do this: upright or bent over. Choose the one that feels more comfortable for you. The main thing is that when you're in the full squeeze, your shoulder should be positioned back behind your torso."
,Roman Chair Leg Raise,N/A,0,3,10-20,,,,,9-10,10,1-2 min,Hanging Leg Raise,Reverse Crunch,"Allow your lower back to round as you curl your legs up. 10-20 reps is a broad range on purpose: just go until you hit RPE 9-10 (0-1 reps shy of failure) with controlled form."
,,,,,,,,,,,,,,
Pull #2 (Mid-Back Focus),,,,,,,,,,,,,,
,Super-ROM Overhand Cable Row,N/A,2,3,10-12,,,,,9,10,1-2 min,Overhand Machine Row,Arm-Out Single-Arm DB Row,"Set up a wide grip pulldown bar on a seated cable row. Using a double overhand grip, perform rows while leaning forward on the negative and then extend your torso to be upright as you finish the row."
,Arms-Extended 45° Hyperextension,N/A,1,2,10-20,,,,,9,9-10,2-3 min,Prisoner 45° Hyperextension,Good Morning (Light Weight),"Keep your arms extended out at 45° as you do back extensions. You should feel a crazy burn in your mid-back and lower back."
,Lean-Back Lat Pulldown,Dropset,2,3,10-12,,,,,9,10,2-3 min,Lean-Back Machine Pulldown,Medium-Grip Pull Up,"Initiate the pulldown with a straight up posture. As you pull the bar down, lean back by about 15-30° to get the mid-back more involved. Softly touch the bar to your chest on every rep and, even though you're leaning back, still control the weight!"
,Inverse DB Zottman Curl,N/A,1,3,10-12,,,,,9-10,10,1-2 min,Slow-Eccentric DB Curl,Hammer Curl,"Do a hammer curl on the positive, then turn your palms facing up at the top and use a palms-up grip on the negative."
,Cable Reverse Flye (Mechanical Dropset),"Mechanical Dropset (on all sets)",0,3,5|4|3+,,,,,9-10,10,1-2 min,Reverse Pec Deck,Bent-Over Reverse DB Flye,"You'll probably want to watch the video for this one. Take ~3 big steps back from the cable machine and do your first 5 reps. After those first 5 reps, immediately (without resting) take 1 step forward and do another 4 reps. Then (without resting) take another step forward and do at least another 3 reps (or until you hit RPE 9-10)."
,Cable Paused Shrug-In,N/A,1,3,10-12,,,,,9-10,10,1-2 min,Machine Shrug,DB Shrug,"Shrug up and in. Think about shrugging ""up to your ears"". 1-2 second pause in the squeeze (at the top) of each rep, then another 1-2 second pause in the stretch (at the bottom) of each rep."
,,,,,,,,,,,,,,
Push #2,,,,,,,,,,,,,,
,Machine Shoulder Press,Dropset,3,3,10-12,,,,,9,10,1-2 min,Cable Shoulder Press,Seated DB Shoulder Press,"Ensure that your elbows break at least 90°. Mind-muscle connection with your delts. Smooth, controlled reps."
,Cross-Body Cable Y-Raise,N/A,1,3,10-12,,,,,9,10,2-3 min,Machine Lateral Raise,DB Lateral Rasie,"Think about ""drawing a sword"" as you do the positive. Sweep your arm up, out and across your body. It may take a few weeks to get used to these if you haven't done them before, but once they click, they really click."
,Paused Assisted Dip,N/A,2,3,8-10,,,,,8-9,10,2-3 min,Decline Machine Chest Press,Decline Barbell Press,"Slow 2-3 second negative. 1-2 second pause at the bottom. Explode with control on the way up. Go as deep as your shoulders comfortably allow, trying to at least break a 90° elbow angle."
,Low-Incline Dumbbell Flye,"Long-length Partials (on all reps of the last set)",1,2,15-20,,,,,9,10,2-3 min,Low-to-High Cable Crossover,Pec-Deck,"Focus on feeling a deep stretch in your pecs at the bottom of each rep. Keep the dumbbells in the bottom ~3/4 of the range of motion as there will be no tension on the pecs at the top. We are including these because the dumbbells' resistance profile really accentuates the stretch."
,Katana Triceps Extension,N/A,1,3,10-12,,,,,9-10,10,2-3 min,Overhead Cable Tricep Extension (Rope),DB Frech Press,"Flare your elbows out at about 45° and keep your elbows locked in place as you complete the extensions."
,Ab Wheel Rollout,N/A,0,3,10-20,,,,,9,9-10,1-2 min,Swiss Ball Rollout,LLPT Plank,"Don't just bend at your hips, use your abs to lower yourself down under control and pull yourself back up. If you don't have the core strength to get all the way extended at the bottom, try to progressively increase the ROM week to week."
,,,,,,,,,,,,,,
Legs #2 (Ham/Glute Focus),,,,,,,,,,,,,,
,Lying Leg Curl,"Long-length Partials (on all reps of the last set)",2,3,8-10,,,,,9,10,1-2 min,Seated Leg Curl,Nordic Ham Curl,"Set the machine so that you get the biggest stretch possible at the bottom. Prevent your butt from popping up as you curl."
,Leg Press,N/A,4,3,8,,,,,8-9,8-9,1-2 min,Belt Squat,High-Bar Back Squat,"Feet lower on the platform for more quad focus. Get as deep as you can without excessive back rounding. Control the negative and do a slight pause at the bottom of each rep. Try to add a little weight each week at the same rep count."
,Smith Machine Lunge,N/A,3,2,8,,,,,8-9,9-10,3-4 min,Barbell Lunge,DB Step Up,"2 sets each leg. Minimize contribution from the back leg. Mind-muscle connection with your glutes here!"
,A1: Machine Hip Adduction,N/A,1,3,10-12,,,,,9-10,10,30s-1 min,Cable Hip Adduction,Copenhagen Hip Adduction,"Mind-muscle connection with your inner thighs. These are great for adding thigh mass from the front! Push them hard!"
,A2: Sissy Squat,N/A,1,3,10-12,,,,,7-8,7-8,30s-1 min,Leg Extension,Goblet Squat,"Allow yourself to come up onto your toes and push your knees forward past your toes. This is safe for the knees. If you feel knee pain doing them, though, feel free to go with a substitution. They may feel awkward at first, but they're really underrated for the quads! Don't give up on them too quickly."
,Standing Calf Raise,"Calf Static Stretch (30 sec hold)",1,3,10-12,,,,,9-10,10,1-2 min,Leg Press Calf Press,Donkey Calf Raise,"1-2 second pause at the bottom of each rep. Instead of just going up onto your toes, think about rolling your ankle back and forth on the balls of your feet."
,,,,,,,,,,,,,,
Arms and Weak Points #2,,,,,,,,,,,,,,
,Weak Point Exercise 1,N/A,3,3,8-12,,,,,9,9-10,1-3 min,,,
,Weak Point Exercise 2,N/A,3,3,8-12,,,,,9,9-10,1-3 min,,,
,Cable Skrull Crusher,N/A,1,2,10-12,,,,,8-9,10,1-2 min,EZ-Bar Skull Crusher,DB Skull Crusher,"Allow the cable to move back behind your head for maximum stretch on the triceps. Reach full extension with your elbows still around eye level at the top."
,Kneeling Overhead Cable Curl,N/A,1,2,10-12,,,,,8-9,10,1-2 min,Overhead Cable Curl,Spider Curl,"Kneel down, stick your arm straight out to the side and do cable curls. You should feel a tight squeeze at the top of each rep on these."
,Triceps Diverging Pressdown (Long Rope or 2 Ropes),N/A,1,2,12-15,,,,,8-9,10,1-2 min,Cable Triceps Kickback,DB Triceps Kickback,"Use two long ropes or one long rope. Lean slightly forward, flare your elbows slightly out and keep your arms back in line with your torso. Then do triceps pressdowns, getting a full, big squeeze at the bottom."
,Incline DB Stretch-Curl,N/A,1,2,12-15,,,,,8-9,10,1-2 min,DB Incline Curl,Bayesian Cable Curl,"Keep your upper back planted against the bench, rotate your arms outward until you feel a massive stretch in your biceps. Go light on these and instead focus on feeling your biceps pull and squeeze."
,Cable Crunch,N/A,1,3,10-12,,,,,9-10,10,1-2 min,Machine Crunch,Plate-Weighted Crunch,"Round your lower back as you crunch. Maintain a mind-muscle connection with your 6-pack."
`;

        // --- 2. STATE ---
        let state = {
            view: 'home',
            currentWeek: 1, // New: Track current week
            routines: [],
            activeRoutine: null,
            activeWorkoutData: null,
            history: [],
            timer: 0,
            isTimerRunning: false,
            timerInterval: null,
            expandedNotes: {}
        };

        // --- 3. PARSER ---
        function parseCSVLine(line) {
            const result = [];
            let start = 0;
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                if (line[i] === '"') inQuotes = !inQuotes;
                else if (line[i] === ',' && !inQuotes) {
                    let val = line.substring(start, i).trim();
                    if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                    val = val.replace(/""/g, '"');
                    result.push(val);
                    start = i + 1;
                }
            }
            let val = line.substring(start).trim();
            if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
            val = val.replace(/""/g, '"');
            result.push(val);
            return result;
        }

        function parseCSV(csvText) {
            const lines = csvText.split(/\r?\n/);
            const routines = [];
            let currentRoutine = null;

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const cols = parseCSVLine(line);
                
                const col0 = cols[0] || '';
                const col1 = cols[1] || ''; 
                
                if (col0 && !col1) {
                    if (currentRoutine) routines.push(currentRoutine);
                    currentRoutine = { id: `r_${routines.length}`, name: col0.replace(/,/g, ''), exercises: [] };
                } else if (col1 && currentRoutine) {
                    currentRoutine.exercises.push({
                        id: `ex_${currentRoutine.id}_${currentRoutine.exercises.length}`,
                        name: col1,
                        intensityTech: cols[2] === 'N/A' ? null : cols[2],
                        warmupSets: parseInt(cols[3]) || 0,
                        workSets: parseInt(cols[4]) || 0,
                        reps: cleanRepString(cols[5]),
                        earlyRpe: cols[10], // Early Set RPE
                        lastRpe: cols[11],  // Last Set RPE
                        rest: cols[12],
                        sub1: cols[13],
                        sub2: cols[14],
                        notes: cols[15]
                    });
                }
            }
            if (currentRoutine) routines.push(currentRoutine);
            return routines;
        }

        // --- 4. CONTROLLER ---
        function init() {
            const storedCSV = localStorage.getItem('user_csv') || DEFAULT_CSV_CONTENT;
            state.routines = parseCSV(storedCSV);
            state.history = JSON.parse(localStorage.getItem('workout_history') || '[]');
            state.currentWeek = parseInt(localStorage.getItem('current_week') || '1'); // Load week

            const active = localStorage.getItem('active_workout');
            if (active) {
                state.activeWorkoutData = JSON.parse(active);
                state.activeRoutine = state.routines.find(r => r.id === state.activeWorkoutData.routineId) || { name: state.activeWorkoutData.routineName };
                state.timer = state.activeWorkoutData.durationSeconds || 0;
                startTimer();
                setView('active');
            } else {
                render();
            }
        }

        function setView(v) { state.view = v; render(); window.scrollTo(0,0); }
        
        function changeWeek(delta) {
            let newWeek = state.currentWeek + delta;
            if (newWeek < 1) newWeek = 1;
            // Limit to something reasonable like 52 if wanted, but unlimited for now is fine
            state.currentWeek = newWeek;
            localStorage.setItem('current_week', newWeek);
            render();
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sc = s % 60;
            return `${m}:${sc < 10 ? '0' : ''}${sc}`;
        }

        function startTimer() {
            if (state.isTimerRunning) return;
            state.isTimerRunning = true;
            state.timerInterval = setInterval(() => {
                state.timer++;
                const el = document.getElementById('timer-display');
                if (el) el.innerText = formatTime(state.timer);
                if (state.activeWorkoutData) {
                    state.activeWorkoutData.durationSeconds = state.timer;
                    localStorage.setItem('active_workout', JSON.stringify(state.activeWorkoutData));
                }
            }, 1000);
        }

        function stopTimer() { state.isTimerRunning = false; clearInterval(state.timerInterval); }

        function startWorkout(routineId) {
            const routine = state.routines.find(r => r.id === routineId);
            if (!routine) return;

            const session = {
                id: crypto.randomUUID(),
                startTime: new Date().toISOString(),
                weekNumber: state.currentWeek, // Save week number
                routineId: routine.id,
                routineName: routine.name,
                exercises: routine.exercises.map(ex => {
                    const sets = [];
                    // Warmups
                    for(let i=0; i<ex.warmupSets; i++) {
                        sets.push({ type: 'warmup', label: 'W', targetRpe: '-', weight: '', reps: '', completed: false });
                    }
                    // Working Sets
                    for(let i=0; i<ex.workSets; i++) {
                        const isLast = i === ex.workSets - 1;
                        sets.push({ 
                            type: 'work', 
                            label: (i + 1).toString(), 
                            targetRpe: isLast ? ex.lastRpe : ex.earlyRpe,
                            intensityNote: isLast ? ex.intensityTech : null,
                            isIntensitySet: isLast && ex.intensityTech,
                            weight: '', 
                            reps: '', 
                            completed: false 
                        });
                    }
                    return { ...ex, setsData: sets };
                }),
                durationSeconds: 0
            };

            state.activeRoutine = routine;
            state.activeWorkoutData = session;
            state.timer = 0;
            localStorage.setItem('active_workout', JSON.stringify(session));
            startTimer();
            setView('active');
        }

        function updateSet(exIdx, setIdx, field, val) {
            state.activeWorkoutData.exercises[exIdx].setsData[setIdx][field] = val;
            localStorage.setItem('active_workout', JSON.stringify(state.activeWorkoutData));
        }

        function toggleSet(exIdx, setIdx) {
            const set = state.activeWorkoutData.exercises[exIdx].setsData[setIdx];
            set.completed = !set.completed;
            localStorage.setItem('active_workout', JSON.stringify(state.activeWorkoutData));
            render(); 
        }

        function substituteExercise(exIdx, newName) {
            state.activeWorkoutData.exercises[exIdx].name = newName;
            state.activeWorkoutData.exercises[exIdx].isSubstituted = true;
            localStorage.setItem('active_workout', JSON.stringify(state.activeWorkoutData));
            closeModal();
            render();
        }

        function finishWorkout() {
            if (!confirm("Finish workout?")) return;
            stopTimer();
            const finished = { ...state.activeWorkoutData, endTime: new Date().toISOString(), durationSeconds: state.timer };
            state.history.unshift(finished);
            localStorage.setItem('workout_history', JSON.stringify(state.history));
            localStorage.removeItem('active_workout');
            state.activeWorkoutData = null;
            state.activeRoutine = null;
            setView('home');
        }

        function getGhost(exName, setIdx) {
            const prev = state.history.find(h => h.exercises.some(e => e.name === exName));
            if (!prev) return null;
            const ex = prev.exercises.find(e => e.name === exName);
            return ex?.setsData[setIdx] || null;
        }

        // --- 5. RENDERERS ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            if (state.view === 'home') app.innerHTML = renderHome();
            else if (state.view === 'active') app.innerHTML = renderActive();
            else if (state.view === 'settings') app.innerHTML = renderSettings();
        }

        function renderHome() {
            return `
                <div class="p-6 pb-24 fade-in">
                    <header class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-black neon-text-cyan tracking-wider italic">PPLA TRACKER</h1>
                            <p class="text-slate-400 text-xs tracking-widest uppercase">System v2.0 // Ready</p>
                        </div>
                        <button onclick="setView('settings')" class="p-2 text-slate-500 hover:text-white transition-colors"><i class="ph ph-gear text-2xl"></i></button>
                    </header>

                    <!-- WEEK SELECTOR -->
                    <div class="mb-8 p-1 neon-border-cyan rounded-xl bg-black/50 backdrop-blur-sm relative overflow-hidden group">
                        <div class="absolute inset-0 bg-cyan-500/10 blur-xl group-hover:bg-cyan-500/20 transition-all"></div>
                        <div class="relative flex items-center justify-between p-3">
                            <button onclick="changeWeek(-1)" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-cyan-900/50 text-cyan-400 transition-all active:scale-95"><i class="ph-bold ph-caret-left text-xl"></i></button>
                            <div class="text-center">
                                <div class="text-[10px] text-cyan-300 uppercase tracking-[0.2em] mb-1">Current Cycle</div>
                                <div class="text-3xl font-black text-white font-mono neon-text-pink">WEEK ${state.currentWeek}</div>
                            </div>
                            <button onclick="changeWeek(1)" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-cyan-900/50 text-cyan-400 transition-all active:scale-95"><i class="ph-bold ph-caret-right text-xl"></i></button>
                        </div>
                    </div>

                    <div class="space-y-4 mb-8">
                        ${state.routines.map(r => `
                            <div onclick="startWorkout('${r.id}')" class="group relative bg-[#0a0a14] p-5 rounded-xl border border-slate-800 shadow-lg cursor-pointer hover:border-cyan-500/50 hover:shadow-[0_0_15px_rgba(0,243,255,0.1)] transition-all active:scale-[0.98] overflow-hidden">
                                <div class="absolute inset-0 bg-gradient-to-r from-cyan-900/0 via-cyan-900/0 to-cyan-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <div class="flex items-center justify-between relative z-10">
                                    <div>
                                        <h3 class="font-bold text-white text-lg group-hover:text-cyan-300 transition-colors tech-font uppercase tracking-wide">${r.name}</h3>
                                        <div class="text-xs text-slate-500 mt-2 flex items-center gap-3 font-mono">
                                            <span class="flex items-center gap-1"><i class="ph-fill ph-barbell text-cyan-600"></i> ${r.exercises.length} EXERCISES</span>
                                        </div>
                                    </div>
                                    <div class="bg-slate-900 border border-slate-700 text-cyan-500 group-hover:bg-cyan-500 group-hover:text-black group-hover:border-cyan-400 transition-all w-10 h-10 rounded flex items-center justify-center shadow-lg">
                                        <i class="ph-bold ph-play"></i>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div>
                        <h2 class="text-sm font-bold text-slate-500 mb-4 flex items-center gap-2 uppercase tracking-widest">
                            <i class="ph ph-clock-counter-clockwise text-pink-500"></i> Log History
                        </h2>
                        ${state.history.length === 0 ? '<div class="text-center text-slate-700 text-sm py-8 font-mono border border-dashed border-slate-800 rounded">NO DATA FOUND</div>' : 
                        state.history.slice(0,5).map((h, i) => `
                            <div class="bg-[#0a0a14] p-4 rounded border border-slate-800 flex justify-between items-center shadow-sm mb-2 hover:border-slate-600 transition-colors">
                                <div>
                                    <div class="font-bold text-slate-300 text-sm tech-font">${h.routineName}</div>
                                    <div class="text-xs text-slate-500 font-mono mt-1">
                                        <span class="text-pink-500">WEEK ${h.weekNumber || '?'}</span> • ${new Date(h.startTime).toLocaleDateString()}
                                    </div>
                                </div>
                                <button onclick="deleteHistory(${i})" class="text-slate-600 hover:text-red-500 transition-colors"><i class="ph ph-trash"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderActive() {
            if (!state.activeWorkoutData) return '';
            
            const exHtml = state.activeWorkoutData.exercises.map((ex, exIdx) => {
                const setsHtml = ex.setsData.map((set, setIdx) => {
                    const ghost = getGhost(ex.name, setIdx);
                    const isWarmup = set.type === 'warmup';
                    
                    // Logic for row styling
                    let bgClass = 'bg-[#0f0f1a]';
                    let borderClass = 'border-slate-800';
                    let textClass = 'text-white';
                    let statusIcon = 'ph-check';

                    if (set.completed) {
                        bgClass = 'bg-cyan-900/20';
                        borderClass = 'border-cyan-800';
                        textClass = 'text-cyan-100';
                        statusIcon = 'ph-check-square';
                    } else if (isWarmup) {
                        bgClass = 'bg-orange-900/10';
                        textClass = 'text-orange-100';
                        borderClass = 'border-orange-900/30';
                    }

                    // Intensity set special styling
                    let intensityIndicator = '';
                    if (set.isIntensitySet) {
                        if (!set.completed) borderClass = 'intensity-border';
                        intensityIndicator = `<div class="col-span-5 text-[9px] text-pink-400 font-bold uppercase tracking-widest text-center pt-1 pb-1 flex items-center justify-center gap-1 bg-pink-900/10"><i class="ph-fill ph-lightning"></i> ${set.intensityNote}</div>`;
                    }

                    return `
                        <div class="mb-2 rounded border ${borderClass} ${bgClass} transition-all relative overflow-hidden group">
                             <div class="grid grid-cols-[30px_1fr_1fr_1fr_40px] gap-2 items-center p-2">
                                <div class="text-center font-bold text-xs ${isWarmup ? 'text-orange-500' : 'text-slate-500'} font-mono">${set.label}</div>
                                
                                <input type="number" placeholder="${ghost?.weight || '-'}" value="${set.weight}" 
                                    oninput="updateSet(${exIdx}, ${setIdx}, 'weight', this.value)"
                                    class="w-full text-center p-1.5 rounded font-mono text-sm font-bold placeholder-slate-700">
                                
                                <input type="number" placeholder="${ghost?.reps || '-'}" value="${set.reps}" 
                                    oninput="updateSet(${exIdx}, ${setIdx}, 'reps', this.value)"
                                    class="w-full text-center p-1.5 rounded font-mono text-sm font-bold placeholder-slate-700">
                                
                                <div class="text-center text-xs font-mono font-medium text-slate-400 bg-black/30 rounded py-2 border border-slate-800/50">
                                    ${set.targetRpe || '-'}
                                </div>

                                <button onclick="toggleSet(${exIdx}, ${setIdx})" class="flex items-center justify-center w-8 h-8 rounded transition-all ${set.completed ? 'bg-cyan-500 text-black shadow-[0_0_10px_rgba(0,243,255,0.4)]' : 'bg-slate-800 text-slate-500 hover:bg-slate-700 hover:text-cyan-400'}">
                                    <i class="ph-bold ${statusIcon}"></i>
                                </button>
                            </div>
                            ${intensityIndicator}
                        </div>
                    `;
                }).join('');

                return `
                    <div class="bg-[#0a0a14] rounded-xl border border-slate-800 mb-6 overflow-hidden shadow-lg relative">
                        <!-- Top Accent Line -->
                        <div class="h-1 w-full bg-gradient-to-r from-slate-800 via-slate-700 to-slate-800"></div>

                        <div class="p-4 border-b border-slate-800">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 mr-2">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <h3 class="font-bold text-slate-100 text-lg leading-tight tech-font tracking-wide">${ex.name}</h3>
                                        ${ex.isSubstituted ? '<span class="text-[9px] bg-orange-900/40 border border-orange-700 text-orange-400 px-1.5 py-0.5 rounded font-bold uppercase tracking-wider">Subbed</span>' : ''}
                                    </div>
                                    <div class="mt-3 flex gap-2">
                                        ${(ex.sub1 || ex.sub2) ? `<button onclick="openSubModal(${exIdx}, '${ex.sub1}', '${ex.sub2}')" class="text-[10px] bg-black border border-slate-700 hover:border-cyan-500 text-slate-400 hover:text-cyan-400 px-3 py-1.5 rounded flex items-center gap-1 transition-all uppercase tracking-wider font-bold"><i class="ph-bold ph-arrows-left-right"></i> Swap</button>` : ''}
                                        ${ex.notes ? `<button onclick="toggleNote(${exIdx})" class="text-[10px] bg-black border border-slate-700 hover:border-pink-500 text-slate-400 hover:text-pink-400 px-3 py-1.5 rounded flex items-center gap-1 transition-all uppercase tracking-wider font-bold"><i class="ph-bold ph-info"></i> Info</button>` : ''}
                                    </div>
                                </div>
                            </div>
                            ${state.expandedNotes[exIdx] ? `<div class="mt-3 text-xs text-cyan-200 bg-cyan-900/10 p-3 rounded border border-cyan-900/30 font-mono border-l-2 border-l-cyan-500">${ex.notes}</div>` : ''}
                        </div>

                        <!-- Header for Sets -->
                        <div class="grid grid-cols-4 gap-2 px-3 py-2 bg-black/40 border-b border-slate-800 text-[9px] uppercase font-bold text-slate-500 text-center tracking-widest">
                            <div>Target</div>
                            <div>LBS</div>
                            <div>Reps</div>
                            <div>RPE</div>
                        </div>

                        <!-- Target Summary Bar -->
                        <div class="grid grid-cols-3 gap-2 px-4 py-2 bg-slate-900/50 text-center text-xs border-b border-slate-800 font-mono text-slate-400">
                             <div><span class="text-slate-600 text-[9px] uppercase block tracking-wider">Sets</span> ${ex.workSets} Work</div>
                             <div><span class="text-slate-600 text-[9px] uppercase block tracking-wider">Target</span> ${ex.reps}</div>
                             <div><span class="text-slate-600 text-[9px] uppercase block tracking-wider">Rest</span> ${ex.rest}</div>
                        </div>

                        <div class="p-2 bg-black/20">
                            ${setsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="pb-32">
                    <div class="sticky top-0 z-20 glass-panel border-b border-slate-800 px-4 py-3 flex justify-between items-center shadow-[0_4px_20px_rgba(0,0,0,0.5)]">
                        <div class="overflow-hidden">
                            <h2 class="font-bold text-white text-sm truncate uppercase tracking-widest tech-font">${state.activeWorkoutData.routineName}</h2>
                            <div class="text-[10px] font-mono text-pink-500 mt-0.5" id="timer-display">WEEK ${state.currentWeek} // ${formatTime(state.timer)}</div>
                        </div>
                        <button onclick="if(confirm('Quit?')) { localStorage.removeItem('active_workout'); setView('home'); }" class="text-xs font-bold text-red-500 hover:text-red-400 px-3 py-1.5 uppercase tracking-wider">Abort</button>
                    </div>
                    <div class="p-4">${exHtml}</div>
                    
                    <!-- Bottom Bar -->
                    <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto glass-panel border-t border-slate-800 p-4 pb-6 flex justify-between items-center shadow-[0_-5px_20px_rgba(0,0,0,0.5)] z-30">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-widest">
                            ${state.activeWorkoutData.exercises.reduce((acc,e)=>acc+e.setsData.filter(s=>s.completed).length,0)} Sets Complete
                        </div>
                        <button onclick="finishWorkout()" class="bg-cyan-600 text-black px-6 py-2.5 rounded font-black hover:bg-cyan-400 active:scale-95 transition-all shadow-[0_0_15px_rgba(0,243,255,0.3)] flex items-center gap-2 uppercase tracking-wider tech-font">
                            Finish <i class="ph-bold ph-caret-right"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderSettings() {
            return `
                <div class="p-4 min-h-screen">
                    <button onclick="setView('home')" class="mb-6 flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-white transition-colors uppercase tracking-widest"><i class="ph-bold ph-arrow-left"></i> Return</button>
                    <h2 class="text-2xl font-black mb-6 text-white tech-font uppercase tracking-widest neon-text-pink">System Config</h2>
                    <div class="bg-[#0a0a14] p-6 rounded-xl border border-slate-800 shadow-lg relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-pink-500"></div>
                        <label class="block text-sm font-bold mb-3 text-cyan-400 uppercase tracking-widest">CSV Database</label>
                        <p class="text-xs text-slate-500 mb-4 font-mono">Paste spreadsheet data to overwrite local storage.</p>
                        <textarea id="csvInput" class="w-full h-48 p-3 text-xs font-mono border border-slate-800 rounded bg-black/50 text-green-400 mb-6 focus:border-cyan-500 focus:shadow-[0_0_10px_rgba(0,243,255,0.2)] outline-none resize-none">${localStorage.getItem('user_csv') || DEFAULT_CSV_CONTENT}</textarea>
                        
                        <div class="flex gap-3">
                            <button onclick="localStorage.setItem('user_csv', document.getElementById('csvInput').value); location.reload()" class="flex-1 bg-slate-800 hover:bg-cyan-700 text-white py-3 rounded text-xs font-bold uppercase tracking-wider transition-colors border border-slate-700">Save System Data</button>
                            <button onclick="if(confirm('Reset?')) { localStorage.removeItem('user_csv'); location.reload(); }" class="px-4 bg-red-900/20 hover:bg-red-900/40 text-red-500 border border-red-900/50 rounded text-xs font-bold uppercase tracking-wider transition-colors">Reset</button>
                        </div>
                    </div>
                    <div class="mt-8 text-center">
                        <p class="text-[10px] text-slate-700 font-mono uppercase">PPLA SYSTEM v2.0 // DEPLOYED</p>
                    </div>
                </div>
            `;
        }

        // --- 6. UTILS ---
        function toggleNote(i) { state.expandedNotes[i] = !state.expandedNotes[i]; render(); }
        
        function openSubModal(idx, s1, s2) {
            const subs = [s1, s2].filter(s => s && s !== 'undefined' && s.trim() !== '');
            if (!subs.length) return alert('No substitutes available.');
            
            const div = document.createElement('div');
            div.id = 'modal-container';
            div.innerHTML = `
                <div class="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4 fade-in">
                    <div class="bg-[#0a0a14] border border-cyan-500/50 rounded-xl shadow-[0_0_30px_rgba(0,243,255,0.15)] w-full max-w-sm overflow-hidden">
                        <div class="p-3 bg-slate-900/50 border-b border-slate-800 flex justify-between items-center">
                            <span class="font-bold text-sm text-cyan-400 uppercase tracking-widest tech-font">Select Alternate</span> 
                            <button onclick="closeModal()" class="text-slate-500 hover:text-white"><i class="ph-bold ph-x"></i></button>
                        </div>
                        <div class="p-2">
                            ${subs.map(s => `<button onclick="substituteExercise(${idx}, '${s.replace(/'/g,"\\'")}')" class="w-full text-left p-4 hover:bg-cyan-900/20 rounded text-sm font-medium border-b border-slate-800 last:border-0 flex justify-between group text-slate-300 hover:text-white transition-all"><span>${s}</span> <i class="ph-bold ph-caret-left text-slate-600 group-hover:text-cyan-400"></i></button>`).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
        }
        function closeModal() { document.getElementById('modal-container')?.remove(); }
        function deleteHistory(i) {
            if(confirm("Delete this log?")) {
                state.history.splice(i, 1);
                localStorage.setItem('workout_history', JSON.stringify(state.history));
                render();
            }
        }

        // Start
        window.onload = init;
    </script>
</body>
</html>
